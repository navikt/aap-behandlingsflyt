name: Bygg og deploy behandlingsflyt

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/pr.yml'
      - '*.md'
      - '.run/*'
      - 'docker-compose.yaml'
  workflow_dispatch:

jobs:
  build:
    name: Bygg og test og push
    runs-on: ubuntu-latest-8-cores
    permissions:
        contents: read
        id-token: write
        packages: write
        checks: write
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: 'temurin'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
            gradle-version: wrapper
      - name: Bygg & test
        run: ./gradlew clean build --continue --stacktrace

      - uses: dorny/test-reporter@v2.2.0
        if: success() || failure()
        with:
          name: test
          path: "**/build/test-results/test/TEST-*.xml"
          reporter: java-junit
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v6
        if: success() || failure() # always run even if the previous step fails
        with:
          report_paths: '**/build/test-results/test/TEST-*.xml'

      - name: Store reports
        if: failure()
        uses: actions/upload-artifact@v5
        with:
            name: reports
            path: |
                **/build/reports/
                **/build/test-results

      - uses: nais/docker-build-push@v0
        id: docker-push
        with:
            team: aap # required
            
    outputs:
        image: ${{ steps.docker-push.outputs.image }}

  bygg-docs:
    name: Bygg docs
    runs-on: ubuntu-latest
    permissions:
        contents: read
        id-token: write
        packages: write
        checks: write
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: 'temurin'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
            gradle-version: wrapper
      - name: Genererer docs
        run: |
          ./gradlew dokkaGenerate
      - name: upload-artifact for docs
        uses: actions/upload-pages-artifact@v4
        with:
          path: './docs/build/dokka/html'


  deploy-pages:
    runs-on: ubuntu-latest
    needs: bygg-docs
    concurrency:
      group: docs
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.test.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


  publiser-kontrakt:
      needs: build
      concurrency:
          group: kontrakt
      permissions:
          contents: write
          packages: write
          id-token: write
      runs-on: ubuntu-latest
      steps:
          - uses: actions/checkout@v6
            with:
                fetch-depth: 0
            #  Ha denne tidlig, s√• action kan skippe raskt om ingen endringer.
          - uses: paulhatch/semantic-version@v5.4.0
            id: tag
            with:
                change_path: "kontrakt/"
                bump_each_commit: true
                tag_prefix: ""
                bump_each_commit_patch_pattern: ''
                major_pattern: "(MAJOR)" # If major bump, include this in the commit message
          - uses: actions/setup-java@v5
            if: ${{ steps.tag.outputs.version_type != 'none' }}
            with:
                java-version: 25
                distribution: 'temurin'
          - uses: gradle/actions/setup-gradle@v5
            with:
                gradle-version: wrapper
          - id: notes
            if: ${{ steps.tag.outputs.version_type != 'none' }}
            run: |
                randomDelimiter=${RANDOM}
                text=$(git --no-pager log $(git describe --tags --abbrev=0)..HEAD --pretty=format:"%h %s" | sed ':a;N;$!ba;s/\n/\n\n/g')
                echo 'CHANGELOG<<$randomDelimiter' >> $GITHUB_OUTPUT
                echo -e "$text" >> $GITHUB_OUTPUT
                echo '$randomDelimiter' >> $GITHUB_OUTPUT
          - if: ${{ steps.tag.outputs.version_type != 'none' }}
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            run: |
                ./gradlew -Pversion=${{ steps.tag.outputs.version }} publish
          - uses:  softprops/action-gh-release@v2
            if: ${{ steps.tag.outputs.version_type != 'none' }}
            id: create_release
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
                tag_name: ${{ steps.tag.outputs.version }}
                name: ${{ steps.tag.outputs.version }}
                body: |
                    Endringer siden sist:
                    ${{ steps.notes.outputs.CHANGELOG }}                

  deploy-dev:
    needs: build
    runs-on: ubuntu-latest
    permissions:
        contents: read
        id-token: write
    concurrency:
      group: deploy-dev
    steps:
      - uses: actions/checkout@v6
      - uses: nais/deploy/actions/deploy@v2
        env:
          PRINT_PAYLOAD: true
          CLUSTER: dev-gcp
          RESOURCE: .nais/dev.yaml
          VAR: image=${{ needs.build.outputs.image }}

  deploy-prod:
      if: ${{ github.ref == 'refs/heads/main' }}
      needs: [publiser-kontrakt, deploy-dev, build]
      runs-on: ubuntu-latest
      concurrency:
        group: deploy-prod
      permissions:
          contents: read
          id-token: write
      steps:
          - uses: actions/checkout@v6
          - uses: nais/deploy/actions/deploy@v2
            env:
                PRINT_PAYLOAD: true
                CLUSTER: prod-gcp
                RESOURCE: .nais/prod.yaml
                VAR: image=${{ needs.build.outputs.image }}
